<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk@2/dist/index.js"></script>
    <style>
        body { margin: 0; background: #222; color: white; font-family: sans-serif; overflow: hidden; }
        
        /* Estilo do Painel do Mestre (Popover) */
        #admin-view { display: none; padding: 10px; flex-direction: column; gap: 8px; text-align: center; }
        input { padding: 8px; width: 90%; border-radius: 4px; border: none; background: #333; color: white; margin: 0 auto; }
        button { padding: 8px; cursor: pointer; background: #6200ee; color: white; border: none; border-radius: 4px; width: 100%; }
        button:hover { background: #7c22ff; }

        /* Estilo do Player (Modal Fullscreen) */
        #player-view { display: none; width: 100vw; height: 100vh; background: black; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <div id="admin-view">
        <h4 style="margin: 0 0 5px 0;">üé¨ Cinematic Controller</h4>
        <input type="text" id="videoUrl" placeholder="Cole o link do YouTube...">
        <button onclick="broadcastVideo()">TRANSMITIR</button>
        <small style="color:#aaa; font-size: 10px; margin-top:5px;">Isso abrir√° a tela cheia para todos.</small>
    </div>

    <div id="player-view">
        <iframe id="yt-iframe" allow="autoplay; encrypted-media; fullscreen"></iframe>
        <button onclick="OBR.modal.close('cinematic-fullscreen')" style="position:absolute; top:10px; right:10px; width:auto; background:red; opacity:0.5;">X</button>
    </div>

    <script>
        OBR.onReady(async () => {
            const queryString = window.location.search;
            const params = new URLSearchParams(queryString);
            const mode = params.get('mode');

            // CENA 1: Se o modo for "fullscreen", estamos rodando o v√≠deo
            if (mode === 'fullscreen') {
                document.getElementById('player-view').style.display = 'block';
                const videoUrl = params.get('url');
                if (videoUrl) {
                    const embedUrl = getYoutubeEmbed(videoUrl);
                    document.getElementById('yt-iframe').src = embedUrl;
                }
            } 
            // CENA 2: Caso contr√°rio, estamos no Popover do menu
            else {
                document.getElementById('admin-view').style.display = 'flex';
                
                // Ouve se algu√©m mandou dar play (para o caso de jogadores)
                OBR.broadcast.onMessage("CINEMATIC_PLAY", (event) => {
                    openFullscreen(event.data.url);
                });
            }
        });

        // Fun√ß√£o para limpar o link do YouTube
        function getYoutubeEmbed(url) {
            let id = "";
            if (url.includes("v=")) id = url.split("v=")[1].split("&")[0];
            else if (url.includes("youtu.be/")) id = url.split("youtu.be/")[1].split("?")[0];
            else if (url.includes("embed/")) id = url.split("embed/")[1].split("?")[0];
            
            return `https://www.youtube.com/embed/${id}?autoplay=1&controls=0&rel=0&modestbranding=1`;
        }

        // Fun√ß√£o chamada pelo bot√£o do Mestre
        async function broadcastVideo() {
            const rawUrl = document.getElementById('videoUrl').value;
            if (!rawUrl) return;

            // 1. Manda o comando para todos os outros
            await OBR.broadcast.sendMessage("CINEMATIC_PLAY", { url: rawUrl });

            // 2. Abre para o pr√≥prio Mestre tamb√©m
            openFullscreen(rawUrl);
        }

        // A√ß√£o que realmente abre a tela cheia
        function openFullscreen(url) {
            OBR.modal.open({
                id: "cinematic-fullscreen",
                url: `/index.html?mode=fullscreen&url=${encodeURIComponent(url)}`,
                fullScreen: true
            });
        }
    </script>
</body>
</html>
